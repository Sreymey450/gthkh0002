<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>តារាងបញ្ជីឈ្មោះសួរសុខទុក្ខកុមារ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Koulen&family=Moul&family=Noto+Sans+Khmer:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans Khmer', sans-serif;
            background-color: #f0f4f8;
        }
        h1, h2, .koulen-font {
            font-family: 'Koulen', cursive;
        }
        .moul-font {
            font-family: 'Moul', cursive;
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            opacity: 0;
            transition: visibility 0s, opacity 0.5s linear;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">

        <!-- Header -->
        <div class="text-center mb-8 border-b pb-4">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 moul-font">តារាងបញ្ជីឈ្មោះសួរសុខទុក្ខកុមារ</h1>
            <p class="text-gray-500 mt-2">កម្មវិធីសម្រាប់កត់ត្រា និងគ្រប់គ្រងទិន្នន័យ</p>
        </div>

        <!-- Input Form -->
        <div class="bg-blue-50 rounded-xl p-6 mb-8 shadow-sm">
            <h2 class="text-2xl font-bold text-blue-800 mb-6 koulen-font">តារាងបញ្ចីឈ្មោះកុមារ</h2>
            <form id="addChildForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Name Input -->
                <div class="col-span-1">
                    <label for="childName" class="block text-sm font-medium text-gray-700 mb-1">ឈ្មោះកុមារ</label>
                    <input type="text" id="childName" name="childName" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                </div>

                <!-- Gender Selection -->
                <div class="col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ភេទ</label>
                    <select id="childGender" name="childGender" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="ប្រុស">ប្រុស</option>
                        <option value="ស្រី">ស្រី</option>
                    </select>
                </div>

                <!-- Village Selection -->
                <div class="col-span-1">
                    <label for="targetVillage" class="block text-sm font-medium text-gray-700 mb-1">ភូមិគោលដៅ</label>
                    <select id="targetVillage" name="targetVillage" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="ភូមិកងវ៉ា">ភូមិកងវ៉ា</option>
                        <option value="ភូមិកងវ៉ាថ្មី">ភូមិកងវ៉ាថ្មី</option>
                        <option value="ភូមិពង្រ">ភូមិពង្រ</option>
                        <option value="ភូមិក្បាលស្ពាន">ភូមិក្បាលស្ពាន</option>
                        <option value="ភូមិម្កាក់">ភូមិម្កាក់</option>
                        <option value="ភូមិដូនឡី">ភូមិដូនឡី</option>
                    </select>
                </div>

                <!-- Comment Input -->
                <div class="md:col-span-2 lg:col-span-1">
                    <label for="comment" class="block text-sm font-medium text-gray-700 mb-1">សម្រង់មតិ</label>
                    <input type="text" id="comment" name="comment" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- Participants Input -->
                <div class="col-span-1">
                    <label for="participants" class="block text-sm font-medium text-gray-700 mb-1">ចំនួនអ្នកចូលរួម</label>
                    <input type="number" id="participants" name="participants" min="1" value="1" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                </div>


                <!-- Submit Button -->
                <div class="col-span-1 md:col-span-2 lg:col-span-3 flex items-end">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 koulen-font text-lg">
                        បន្ថែមទៅក្នុងបញ្ជី
                    </button>
                </div>
            </form>
        </div>

        <!-- Children List Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">ល.រ</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">ឈ្មោះ</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">ភេទ</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">ភូមិគោលដៅ</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">សម្រង់មតិ</th>
                        <th class="px-6 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">អ្នកចូលរួម</th>
                        <th class="px-6 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">សកម្មភាព</th>
                    </tr>
                </thead>
                <tbody id="childList" class="divide-y divide-gray-200">
                    <!-- Rows will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- Summary and Save Button -->
        <div class="mt-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="bg-green-100 text-green-800 text-lg font-bold px-6 py-3 rounded-lg shadow">
                កុមារបានសួរសុខទុក្ខសរុប៖ <span id="totalChildren" class="koulen-font text-2xl">0</span> នាក់
            </div>
            <button id="saveButton" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 koulen-font text-lg">
                រក្សាទុកទិន្នន័យ
            </button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">ទិន្នន័យត្រូវបានរក្សាទុកដោយជោគជ័យ!</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get DOM elements
            const form = document.getElementById('addChildForm');
            const childListBody = document.getElementById('childList');
            const totalChildrenSpan = document.getElementById('totalChildren');
            const saveButton = document.getElementById('saveButton');
            const toast = document.getElementById('toast');

            // Data storage
            let children = [];

            // Load data from localStorage
            function loadData() {
                const savedChildren = localStorage.getItem('childVisitData');
                if (savedChildren) {
                    children = JSON.parse(savedChildren);
                    renderTable();
                }
            }

            // Save data to localStorage
            function saveData() {
                localStorage.setItem('childVisitData', JSON.stringify(children));
                showToast('ទិន្នន័យត្រូវបានរក្សាទុកដោយជោគជ័យ!');
            }
            
            // Show a toast notification
            function showToast(message) {
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            // Render the table with current data
            function renderTable() {
                // Clear existing table rows
                childListBody.innerHTML = '';
                
                // If no children, show a message
                if (children.length === 0) {
                     childListBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-500">មិនទាន់មានទិន្នន័យនៅឡើយ...</td></tr>`;
                } else {
                    // Populate table with data
                    children.forEach((child, index) => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 font-semibold">${escapeHTML(child.name)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escapeHTML(child.gender)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escapeHTML(child.village)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escapeHTML(child.comment)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center koulen-font">${child.participants}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                <button data-index="${index}" class="delete-btn text-red-600 hover:text-red-900 transition-colors">លុប</button>
                            </td>
                        `;
                        childListBody.appendChild(row);
                    });
                }
                updateTotal();
            }
            
            // Function to escape HTML special characters to prevent XSS
            function escapeHTML(str) {
                if (str === null || str === undefined) {
                    return '';
                }
                return str.toString().replace(/[&<>"']/g, function(match) {
                    return {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;'
                    }[match];
                });
            }

            // Update the total count of children
            function updateTotal() {
                totalChildrenSpan.textContent = children.length;
            }

            // Handle form submission to add a new child
            form.addEventListener('submit', (e) => {
                e.preventDefault();

                const newChild = {
                    name: form.childName.value.trim(),
                    gender: form.childGender.value,
                    village: form.targetVillage.value,
                    comment: form.comment.value.trim(),
                    participants: parseInt(form.participants.value, 10)
                };
                
                if (newChild.name && newChild.participants > 0) {
                    children.push(newChild);
                    renderTable();
                    form.reset();
                    form.childName.focus();
                } else {
                    alert('សូមបំពេញឈ្មោះ និងចំនួនអ្នកចូលរួមឲ្យបានត្រឹមត្រូវ។');
                }
            });

            // Handle delete button clicks
            childListBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const indexToDelete = parseInt(e.target.dataset.index, 10);
                    // Confirmation dialog
                    const isConfirmed = confirm(`តើអ្នកពិតជាចង់លុបឈ្មោះ "${children[indexToDelete].name}" មែនទេ?`);
                    if(isConfirmed){
                        children.splice(indexToDelete, 1);
                        renderTable();
                    }
                }
            });
            
            // Handle save button click
            saveButton.addEventListener('click', saveData);

            // Initial load
            loadData();
        });
    </script>
</body>
</html>
